/**
 *  Version 2.1
 *      -Contributors: "mindinquiring" : filter to exclude any stylesheet other than print.
 *  Tested ONLY in IE 8 and FF 3.6. No official support for other browsers, but will
 *      TRY to accomodate challenges in other browsers.
 *  Example:
 *      Print Button: <div id="print_button">Print</div>
 *      Print Area  : <div class="PrintArea"> ... html ... </div>
 *      Javascript  : <script>
 *                       $("div#print_button").click(function(){
 *                           $("div.PrintArea").printArea( [OPTIONS] );
 *                       });
 *                     </script>
 *  options are passed as json (json example: {mode: "popup", popClose: false})
 *
 *  {OPTIONS} | [type]    | (default), values      | Explanation
 *  --------- | --------- | ---------------------- | -----------
 *  @mode     | [string]  | ("iframe"),"popup"     | printable window is either iframe or browser popup
 *  @popHt    | [number]  | (500)                  | popup window height
 *  @popWd    | [number]  | (400)                  | popup window width
 *  @popX     | [number]  | (500)                  | popup window screen X position
 *  @popY     | [number]  | (500)                  | popup window screen Y position
 *  @popTitle | [string]  | ('')                   | popup window title element
 *  @popClose | [boolean] | (false),true           | popup window close after printing
 *  @strict   | [boolean] | (undefined),true,false | strict or loose(Transitional) html 4.01 document standard or undefined to not include at all (only for popup option)
 */
(function($) {
	var lab_skills = true;
	var preceptor_signoff_report = false;
    var counter = 0;
    var modes = { iframe : "iframe", popup : "popup" };
    var defaults = { mode     : modes.iframe,
                     popHt    : 500,
                     popWd    : 400,
                     popX     : 200,
                     popY     : 200,
                     popTitle : '',
                     popClose : false };

    var settings = {};//global settings

    $.fn.printArea = function( options )
        {
            $.extend( settings, defaults, options );
			
			if ($(".graph_wrapper").length > 0) {
				lab_skills = false;
				if ( $(".preceptor_signoff_eureka_report_wrapper").length > 0) {
					preceptor_signoff_report = true;
				}
			}
			
            counter++;
            var idPrefix = "printArea_";
            $( "[id^=" + idPrefix + "]" ).remove();
            var ele = getFormData( $(this) );

            settings.id = idPrefix + counter;

            var writeDoc;
            var printWindow;

            switch ( settings.mode )
            {
                case modes.iframe :
                    var f = new Iframe();
                    writeDoc = f.doc;
                    printWindow = f.contentWindow || f;
                    break;
                case modes.popup :
                    printWindow = new Popup();
                    writeDoc = printWindow.doc;
            }

            writeDoc.open();
            writeDoc.write( docType() + "<html>" + getHead() + getBody(ele) + "</html>" );
            writeDoc.close();

            printWindow.focus();
            printWindow.print();

            if ( settings.mode == modes.popup && settings.popClose )
                printWindow.close();
        }

    function docType()
    {
        if ( settings.mode == modes.iframe || !settings.strict ) return "";

        var standard = settings.strict == false ? " Trasitional" : "";
        var dtd = settings.strict == false ? "loose" : "strict";

        return '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01' + standard + '//EN" "http://www.w3.org/TR/html4/' + dtd +  '.dtd">';
    }
	
	function convertCanvasToImage(canvas) {
		var image = new Image();
		image.src = canvas[0].toDataURL("image/png");
		return image;
	}

    function getHead()
    {
        var head = "<head><title>" + settings.popTitle + "</title>";
		
		
		if (lab_skills) {
			head += "<link type='text/css' rel='stylesheet' href='/css/jquery.eurekaGraph.css'>";
		}
		else {
			head += "<link type='text/css' rel='stylesheet' href='/css/library/Reports/Form/eureka-report.css'>";
			
			if (preceptor_signoff_report) {
				head += "<link type='text/css' rel='stylesheet' href='/css/library/Reports/Form/preceptor-signoff-report.css'>";
			}
		}
		
		head += "<link type='text/css' rel='stylesheet' href='/css/jquery.jqplot.min.css'>";
		head += "<link type='text/css' rel='stylesheet' href='/css/themeroller/default/jquery-ui-1.8.16.custom.css'>";
		head += "<link type='text/css' rel='stylesheet' href='/css/global.css'>";
		head += "<style type='text/css' media='print'>";
		
		if (lab_skills) {
			head += "@page { size:landscape; margin:2cm; }";
			head += ".key {right:1.75em; width:290px; }";
		}
		else {
			head += ".eureka_graph_wrapper  { width:392px; }";
			head += ".eureka_attempts_table_wrapper { max-height:none; }";
			head += ".eureka_table_wrapper .shift_summary_display_large .shift_summary_date_display { font-size:8pt; }";
			head += ".eureka_table_wrapper .shift_summary_display_large .shift_summary_location_display { font-size:8pt; }";
			head += ".key { font-size:8pt; }";
			head += ".key-wrapper { width:600px; margin-top:1.5em; margin-left:0em; }";
			head += "td { vertical-align:middle; }";
			head += ".details-wrapper { position:relative; }";
			head += ".eureka_reached { background:transparent; }";
			head += "h3 { color:#655d57; }";
			head += ".eureka_student_report_wrapper {margin-top:0em;}"
			
			if (preceptor_signoff_report) {
				head += "@page { size:portrait; margin:2cm; }";
				head += ".eureka_table_wrapper {width:100%; margin-top:0.5em;}";
				head += ".eureka_success_cell {width:112px;}";
				head += ".eureka_attempts_table_wrapper{overflow:hidden;}";
				head += ".details-wrapper{width:100%;margin-left:-2em;}";
				head += ".eureka_graph_wrapper {width:100%; margin-top:-0.5em;}";
				head += ".eureka_home {top:-1.5em;}";
				head += ".signoffs_graphs_wrapper {width:100%; margin-top:1em;}";
				head += ".eureka_graph_wrapper .key-wrapper {width:350px; margin:0 auto;padding-left:1em;}";
			}
			else {
				head += "@page { size:landscape; margin:2cm; }";
			}
		}
		
		head += ".print-eureka { display:none; }";
		head += "#close-eureka-modal { display:none; }";
		head += "</style>";
		
        $(document).find("link")
            .filter(function(){
                    return $(this).attr("rel").toLowerCase() == "stylesheet";
                })
            .filter(function(){ // this filter contributed by "mindinquiring"
                    var media = $(this).attr("media");
                    return (media.toLowerCase() == "" || media.toLowerCase() == "print")
                })
            .each(function(){
                    head += '<link type="text/css" rel="stylesheet" href="' + $(this).attr("href") + '" >';
                });
        head += "</head>";
        return head;
    }

    function getBody( printElement )
    {
		var toPrint = $(printElement);
		
		toPrint.find("canvas").each(function(){
			var img = convertCanvasToImage($(this));
			$(img).css("position", "absolute");
			$(img).css("top", $(this).css("top"));
			$(img).css("left", $(this).css("left"));
			$(this).parent().append(img);
			$(this).remove();
		});
		
        return '<body><div class="' + toPrint.attr("class") + '">' + toPrint.html() + '</div></body>';
    }

    function getFormData( ele )
    {
        $("input,select,textarea", ele).each(function(){
            // In cases where radio, checkboxes and select elements are selected and deselected, and the print
            // button is pressed between select/deselect, the print screen shows incorrectly selected elements.
            // To ensure that the correct inputs are selected, when eventually printed, we must inspect each dom element
            var type = $(this).attr("type");
            if ( type == "radio" || type == "checkbox" )
            {
                if ( $(this).is(":not(:checked)") ) this.removeAttribute("checked");
                else this.setAttribute( "checked", true );
            }
            else if ( type == "text" )
                this.setAttribute( "value", $(this).val() );
            else if ( type == "select-multiple" || type == "select-one" )
                $(this).find( "option" ).each( function() {
                    if ( $(this).is(":not(:selected)") ) this.removeAttribute("selected");
                    else this.setAttribute( "selected", true );
                });
            else if ( type == "textarea" )
            {
                var v = $(this).attr( "value" );
                if ($.browser.mozilla)
                {
                    if (this.firstChild) this.firstChild.textContent = v;
                    else this.textContent = v;
                }
                else this.innerHTML = v;
            }
        });
        return ele;
    }

    function Iframe()
    {
        var frameId = settings.id;
        var iframeStyle = 'border:0;position:absolute;width:0px;height:0px;left:0px;top:0px;';
        var iframe;

        try
        {
            iframe = document.createElement('iframe');
            document.body.appendChild(iframe);
            $(iframe).attr({ style: iframeStyle, id: frameId, src: "" });
            iframe.doc = null;
            iframe.doc = iframe.contentDocument ? iframe.contentDocument : ( iframe.contentWindow ? iframe.contentWindow.document : iframe.document);
        }
        catch( e ) { throw e + ". iframes may not be supported in this browser."; }

        if ( iframe.doc == null ) throw "Cannot find document.";

        return iframe;
    }

    function Popup()
    {
        var windowAttr = "location=yes,statusbar=no,directories=no,menubar=no,titlebar=no,toolbar=no,dependent=no";
        windowAttr += ",width=" + settings.popWd + ",height=" + settings.popHt;
        windowAttr += ",resizable=yes,screenX=" + settings.popX + ",screenY=" + settings.popY + ",personalbar=no,scrollbars=no";

        var newWin = window.open( "", "_blank",  windowAttr );

        newWin.doc = newWin.document;

        return newWin;
    }
})(jQuery);